<!--
THe problem:

1) UTM parameters only exist in the URL of the first page the user lands on.

2) If the user clicks around before submitting a form, that data is lost, unless we store it

3) Canâ€™t store data without consent, because of CookieYes, would be very bad

4) The form (Marketo) is embedded and not native to WordPress, so it must be accessed via JS

5) Marketo sends leads to Salesforce, so we must inject data into fields Marketo will pass along.


This method will basically allow us to use UTM parameter pass-through to persist the original source data across internal pages before the user consents to cookies. The query string will stay on the url in the browser regardless of what page the user ends up on, and then be removed once the user either accepts or declines cookies

fake utm query paramater to add to the end of the url for testing: 

?utm_source=google&utm_medium=cpc&utm_campaign=summer_sale&gclid=abc123

-->



<script data-cookieyes="cookieyes-analytics" >
// Cookie data storage script - captures UTM data, plugs it into 4 cookies ('iiq_utm_source', 'iiq_utm_medium', 'iiq_utm_campaign', & 'iiq_utm_content'), then plugs the data from those cookies into hidden fields within Marketo forms ONLY IF there isn't any data already within those fields
(function () {
  // config & cookie variables
  const COOKIE_HOURS = 48;// how long each of the 4 cookies lasts
  const COOKIE_PATH = '/';
  const COOKIE_DOMAIN = '';// add domain if planning on using for multiple domains or cross-subdomain

  const UTM_KEYS = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content'];
  const FIELD_NAMES = {
    utm_source:   ['utm_source',   'mkto_UTM_Source__c'],
    utm_medium:   ['utm_medium',   'mkto_UTM_Medium__c'],
    utm_campaign: ['utm_campaign', 'mkto_UTM_Campaign__c'],
    utm_content:  ['utm_content',  'mkto_UTM_Content__c']
  };

  // map all the UTM keys -> cookie names
  const COOKIE_NAME_MAP = {
    utm_source:   'iiq_utm_source',
    utm_medium:   'iiq_utm_medium',
    utm_campaign: 'iiq_utm_campaign',
    utm_content:  'iiq_utm_content'
  };

  // Cookie storage
  const cookieStorage = {
    setItem: function (name, value, hours = COOKIE_HOURS) {
      try {
        const cookieDate = new Date();
        cookieDate.setTime(cookieDate.getTime() + (hours * 60 * 60 * 1000));
        const expires = 'expires=' + cookieDate.toUTCString();
        const secure = (location.protocol === 'https:') ? ' Secure;' : '';
        const domain = COOKIE_DOMAIN ? (' domain=' + COOKIE_DOMAIN + ';') : '';
        document.cookie =
          encodeURIComponent(name) + '=' + encodeURIComponent(value) + '; ' +
          expires + '; path=' + COOKIE_PATH + ';' + domain + ' SameSite=Lax;' + secure;
      } catch (err) { console.warn('[UTM Cookie] setItem failed:', name, err); }
    },
    getItem: function (name) {
      try {
        const target = encodeURIComponent(name) + '=';
        const cookieList = document.cookie ? document.cookie.split(';') : [];
        for (let cookieItems of cookieList) {
          cookieItems = cookieItems.trim();
          if (cookieItems.indexOf(target) === 0) return decodeURIComponent(cookieItems.substring(target.length));
        }
        return null;
      } catch (err) { console.warn('[UTM Cookie] getItem failed:', name, err); return null; }
    },
    removeItem: function (name) {
      try {
        const past = 'Thu, 01 Jan 1970 00:00:00 GMT';
        const secure = (location.protocol === 'https:') ? ' Secure;' : '';
        const domain = COOKIE_DOMAIN ? (' domain=' + COOKIE_DOMAIN + ';') : '';
        document.cookie =
          encodeURIComponent(name) + '=; expires=' + past + '; path=' + COOKIE_PATH + ';' + domain + ' SameSite=Lax;' + secure;
      } catch (err) { console.warn('[UTM Cookie] removeItem failed:', name, err); }
    }
  };

  // URL helpers
  function hasUtmsInURL() {
    const qs = new URLSearchParams(window.location.search);
    return UTM_KEYS.some(utmKey => qs.has(utmKey));
  }
  function getUtmsFromURL() {
    const qs = new URLSearchParams(window.location.search);
    const out = {};
    UTM_KEYS.forEach(utmKey => {
      const val = qs.get(utmKey);
      if (val) out[utmKey] = val.trim();
    });
    return out;
  }


  // cookie helpers
  // 'k' means 'key', 'v', means 'value'
  function saveUtms(utms) {
    try {
      Object.entries(utms).forEach(([k, v]) => {
        cookieStorage.setItem(COOKIE_NAME_MAP[k] || k, v, COOKIE_HOURS);
      });
    } catch (err) { console.warn('[UTM Cookie] Failed to save UTMs:', err); }
  }
  function loadUtms() {
    const out = {};
    UTM_KEYS.forEach(k => {
      const v = cookieStorage.getItem(COOKIE_NAME_MAP[k] || k);
      if (v) out[k] = v; // keep keys plain: utm_source, etc.
    });
    return out;
  }

  // Marketo fallback (cookies -> hidden fields) should only run when URL has NO UTMs
  function applyCookieUtmsToForm(form) {
    if (hasUtmsInURL()) return;// if URL has UTMs, let marketo handle it - core functionality of marketo
    try {
      const stored = loadUtms();
      if (!Object.keys(stored).length) return;

      const formElem = form.getFormElem()[0];
      const currentVals = form.getValues();
      const updates = {};

      UTM_KEYS.forEach(utmKey => {
        const candidates = FIELD_NAMES[utmKey] || [utmKey];
        for (const fieldName of candidates) {
          if (fieldName in currentVals) {
            const input = formElem.elements[fieldName];
            const existing = (currentVals[fieldName] || (input && input.value) || '').trim();
            const fallback = (stored[utmKey] || '').trim();
            if (!existing && fallback) {
              updates[fieldName] = fallback;// fill only the empty fields
            }
            break;
          }
        }
      });

      if (Object.keys(updates).length) form.setValues(updates);
    } catch (err) { console.warn('[UTM Cookie] Failed to apply UTM data to form:', err); }
  }

  // \wait for Marketo, then apply cookie fallback if needed. should run AFTER marketo has loaded
  (function waitForMkto(maxMs = 10000, step = 200) {
    const ready = !!(window.MktoForms2 && typeof MktoForms2.whenReady === 'function');
    if (ready) {
      MktoForms2.whenReady(function (form) {
        // debug what fields Marketo exposes
        // try { console.log('[Mkto] keys:', Object.keys(form.getValues())); } catch (e) {}
        applyCookieUtmsToForm(form);
      });
      return;
    }
    if (maxMs <= 0) return;
    setTimeout(() => waitForMkto(maxMs - step, step), step);
  })();

  // Init: on any page WITH UTMs, store them for 48hours
  (function init() {
    const urlUtms = getUtmsFromURL();
    if (Object.keys(urlUtms).length) {
      saveUtms(urlUtms);// write/refresh cookies; Marketo will use URL on this page
    }
  })();

  // helper for testing
  window.__resetUTMCookies = function () {
    UTM_KEYS.forEach(k => cookieStorage.removeItem(COOKIE_NAME_MAP[k] || k));
    console.log('[UTM Cookie] Cleared all iiq_utm cookies.');
  };
})();
</script>
