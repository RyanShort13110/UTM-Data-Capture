<!--
THe problem:

1) UTM parameters only exist in the URL of the first page the user lands on.

2) If the user clicks around before submitting a form, that data is lost, unless we store it

3) Canâ€™t store data without consent, because of CookieYes, would be very bad

4) The form (Marketo) is embedded and not native to WordPress, so it must be accessed via JS

5) Marketo sends leads to Salesforce, so we must inject data into fields Marketo will pass along.


This method will basically allow us to use UTM parameter pass-through to persist the original source data across internal pages before the user consents to cookies. The query string will stay on the url in the browser regardless of what page the user ends up on, and then be removed once the user either accepts or declines cookies

fake utm query paramater to add to the end of the url for testing: 

?utm_source=google&utm_medium=cpc&utm_campaign=summer_sale&gclid=abc123

-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UTM Tracker</title>
  </head>
  <body>
    <h1>UTM Tracker Demo</h1>

    <a href="/contact">Contact Page</a><br />
    <a href="/about">About Page</a><br /><br />

    <form id="leadForm">
      <h2>Lead Form</h2>
      <input type="text" placeholder="Your Name" required /><br /><br />

      <!-- Hidden fields for UTM data -->
      <input type="hidden" name="utm_source" />
      <input type="hidden" name="utm_medium" />
      <input type="hidden" name="utm_campaign" />
      <!-- <input type="hidden" name="utm_term" /> -->
      <input type="hidden" name="utm_content" />
      <!-- <input type="hidden" name="gclid" /> -->

      <button type="submit">Submit</button>
    </form>

    <script>
      // Grab UTM & GCLID from the URL
      function getUTMParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          utm_source: params.get("utm_source"),
          utm_medium: params.get("utm_medium"),
          utm_campaign: params.get("utm_campaign"),
          // utm_term: params.get("utm_term"),
          utm_content: params.get("utm_content"),
          // gclid: params.get("gclid"),
        };
      }

      // Append UTM data to all internal links
      // function appendUTMToInternalLinks(utm) {
      //   const links = document.querySelectorAll('a[href^="/"]');
      //   links.forEach(link => {
      //     const url = new URL(link.href, window.location.origin);
      //     for (const key in utm) {
      //       if (utm[key]) url.searchParams.set(key, utm[key]);
      //     }
      //     link.href = url.pathname + url.search;
      //   });
      // }

      // Set hidden fields in the form
      function populateFormFields(data) {
        const form = document.getElementById("mktoForm_3211");
        if (!form) return;
        Object.entries(data).forEach(([key, value]) => {
          const field = form.querySelector(`[name="${key}"]`);
          if (field) field.value = value || "";
        });
      }

      // CookieYes consent check
      function hasConsent() {
        return window.CookieYes?.consent?.analytics === true;
      }

      // Store data after consent
      function storeUTM(utm) {
        if (hasConsent()) {
          localStorage.setItem("leadSourceData", JSON.stringify(utm));
        }
      }

      // Main conditional logic
      (function () {
        const utm = getUTMParams();

        // 1. Append UTM to internal links
        //appendUTMToInternalLinks(utm);

        // 2. Handle consent
        if (hasConsent()) {
          storeUTM(utm);
        } else {
          window.addEventListener("cookieyes_consent_update", () => {
            if (hasConsent()) storeUTM(utm);
          });
        }

        // 3. Load from localStorage or URL
        const stored = JSON.parse(
          localStorage.getItem("leadSourceData") || "{}"
        );
        const dataToUse = Object.values(utm).some(Boolean) ? utm : stored;

        // 4. Inject UTM into form
        populateFormFields(dataToUse);
      })();

      // For demo purposes: alert data from hidden fields
      document
        .getElementById("leadForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const entries = Object.fromEntries(formData.entries());
          alert("Form submitted with:\n" + JSON.stringify(entries, null, 2));
        });

      // this removes the UTM code from the url once cookies are accepted or declined
      function removeUTMFromURL() {
        const url = new URL(window.location.href);
        const paramsToRemove = [
          "utm_source",
          "utm_medium",
          "utm_campaign",
          "utm_term",
          "utm_content",
          "gclid",
        ];

        let changed = false;
        paramsToRemove.forEach((param) => {
          if (url.searchParams.has(param)) {
            url.searchParams.delete(param);
            changed = true;
          }
        });

        if (changed) {
          window.history.replaceState(
            {},
            "",
            url.pathname + url.search + url.hash
          );
        }
      }

      // Wait for CookieYes consent update to clean up URL
      window.addEventListener("cookieyes_consent_update", () => {
        removeUTMFromURL();
      });
    </script>
  </body>
</html>









<!-- 


<script>
(function () {
  const utmFieldMap = {
    utm_source: 'mkto_UTM_Source__c',
    utm_medium: 'mkto_UTM_Medium__c',
    utm_campaign: 'mkto_UTM_Campaign__c',
    utm_content: 'mkto_UTM_Content__c'
  };

  let utmData = {};

  // Extract UTM from URL
  function extractUTMFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    for (const [utmKey, fieldName] of Object.entries(utmFieldMap)) {
      const value = urlParams.get(utmKey);
      if (value) {
        utmData[fieldName] = value;

        // Only store if user gave consent
        if (window.CookieYes?.consent?.analytics) {
          localStorage.setItem('utm_' + utmKey, value);
        }
      }
    }
  }

  // Get UTM from localStorage if no URL param is present
  function fillFromStorageIfAllowed() {
    if (!window.CookieYes?.consent?.analytics) return;
    for (const [utmKey, fieldName] of Object.entries(utmFieldMap)) {
      if (!utmData[fieldName]) {
        const stored = localStorage.getItem('utm_' + utmKey);
        if (stored) {
          utmData[fieldName] = stored;
        }
      }
    }
  }

  // Wait for form load and populate if fields exist
  MktoForms2.whenReady(function (form) {
    const formFields = form.getFormElem()[0].elements;
    const availableFields = new Set(Array.from(formFields).map(f => f.name));

    const filtered = {};
    for (const [field, value] of Object.entries(utmData)) {
      if (availableFields.has(field)) {
        filtered[field] = value;
      }
    }

    form.setValues(filtered);
  });

  // Main entry point
  function initUTMTracking() {
    extractUTMFromURL();
    fillFromStorageIfAllowed();
  }

  // If consent has already been given
  if (window.CookieYes?.consent?.analytics) {
    initUTMTracking();
  }

  // If consent is granted after page load
  document.addEventListener('cookieyes_consent_update', function () {
    if (window.CookieYes?.consent?.analytics) {
      initUTMTracking();
    }
  });
})();
</script> -->



<!-- New version of UTM tracker software -->


<script>
(function () {
  // Map UTM query parameters to Marketo hidden field names
  const utmFieldMap = {
    utm_source: 'mkto_UTM_Source__c',
    utm_medium: 'mkto_UTM_Medium__c',
    utm_campaign: 'mkto_UTM_Campaign__c',
    utm_content: 'mkto_UTM_Content__c'
  };

  let utmData = {}; // Final UTM values to populate into the form

  /**
   * Check if user has consented to analytics cookies via CookieYes.
   * Acceptable values:
   *   - "yes" (opt-out mode)
   *   - { consent: "yes" } (structured JSON)
   */
  function hasAnalyticsConsent() {
    try {
      const cookie = document.cookie.split('; ').find(row => row.startsWith('cookieyes-consent='));

      if (!cookie) return false;

      const raw = decodeURIComponent(cookie.split('=')[1]);

      if (raw === 'yes') return true;

      if (raw.startsWith('{')) {
        const parsed = JSON.parse(raw);
        return parsed?.consent === 'yes';
      }
    } catch (err) {
      console.warn('[UTM Tracker] Consent check failed:', err);
    }

    return false;
  }

  /**
   * Get UTM values from the URL. If consent is given, store them.
   */
  function extractUTMFromURL() {
    const urlParams = new URLSearchParams(window.location.search);

    for (const [utmKey, fieldName] of Object.entries(utmFieldMap)) {
      const value = urlParams.get(utmKey);
      if (value) {
        utmData[fieldName] = value;

        if (hasAnalyticsConsent()) {
          try {
            localStorage.setItem('utm_' + utmKey, value);
          } catch (e) {
            console.warn('[UTM Tracker] Failed to store UTM param:', utmKey, e);
          }
        }
      }
    }
  }

  /**
   * Fill missing UTM data from localStorage if consent allows it.
   */
  function fillFromStorageIfAllowed() {
    if (!hasAnalyticsConsent()) return;

    for (const [utmKey, fieldName] of Object.entries(utmFieldMap)) {
      if (!utmData[fieldName]) {
        const stored = localStorage.getItem('utm_' + utmKey);
        if (stored) {
          utmData[fieldName] = stored;
        }
      }
    }
  }

  /**
   * Push UTM data into hidden fields if the user has given consent.
   */
  function applyUTMToForm(form) {
    if (!hasAnalyticsConsent()) return;

    try {
      const formFields = form.getFormElem()[0].elements;
      const availableFields = new Set(Array.from(formFields).map(f => f.name));

      const filtered = {};
      for (const [field, value] of Object.entries(utmData)) {
        if (availableFields.has(field)) {
          filtered[field] = value;
        }
      }

      form.setValues(filtered);
    } catch (err) {
      console.warn('[UTM Tracker] Failed to apply UTM data to form:', err);
    }
  }

  /**
   * Main logic: extract UTM, store if allowed, and set values if allowed.
   */
  function initUTMTracking() {
    extractUTMFromURL();
    fillFromStorageIfAllowed();
  }

  // Run when any Marketo form loads
  MktoForms2.whenReady(function (form) {
    applyUTMToForm(form);
  });

  // Run on initial page load
  initUTMTracking();

  // Re-run if consent is granted later
  document.addEventListener('cookieyes_consent_update', function () {
    initUTMTracking();
  });
})();
</script>






<script data-cookieyes="cookieyes-analytics" >
// Cookie data storage script - captures UTM data, plugs it into 4 cookies ('iiq_utm_source', 'iiq_utm_medium', 'iiq_utm_campaign', & 'iiq_utm_content'), then plugs the data from those cookies into hidden fields within Marketo forms ONLY IF there isn't any data already within those fields
(function () {
  // config & cookie variables
  const COOKIE_HOURS = 48;// how long each of the 4 cookies lasts
  const COOKIE_PATH = '/';
  const COOKIE_DOMAIN = '';// add domain if planning on using for multiple domains or cross-subdomain

  const UTM_KEYS = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content'];
  const FIELD_NAMES = {
    utm_source:   ['utm_source',   'mkto_UTM_Source__c'],
    utm_medium:   ['utm_medium',   'mkto_UTM_Medium__c'],
    utm_campaign: ['utm_campaign', 'mkto_UTM_Campaign__c'],
    utm_content:  ['utm_content',  'mkto_UTM_Content__c']
  };

  // map all the UTM keys -> cookie names
  const COOKIE_NAME_MAP = {
    utm_source:   'iiq_utm_source',
    utm_medium:   'iiq_utm_medium',
    utm_campaign: 'iiq_utm_campaign',
    utm_content:  'iiq_utm_content'
  };

  // Cookie storage
  const cookieStorage = {
    setItem: function (name, value, hours = COOKIE_HOURS) {
      try {
        const cookieDate = new Date();
        cookieDate.setTime(cookieDate.getTime() + (hours * 60 * 60 * 1000));
        const expires = 'expires=' + cookieDate.toUTCString();
        const secure = (location.protocol === 'https:') ? ' Secure;' : '';
        const domain = COOKIE_DOMAIN ? (' domain=' + COOKIE_DOMAIN + ';') : '';
        document.cookie =
          encodeURIComponent(name) + '=' + encodeURIComponent(value) + '; ' +
          expires + '; path=' + COOKIE_PATH + ';' + domain + ' SameSite=Lax;' + secure;
      } catch (err) { console.warn('[UTM Cookie] setItem failed:', name, err); }
    },
    getItem: function (name) {
      try {
        const target = encodeURIComponent(name) + '=';
        const cookieList = document.cookie ? document.cookie.split(';') : [];
        for (let cookieItems of cookieList) {
          cookieItems = cookieItems.trim();
          if (cookieItems.indexOf(target) === 0) return decodeURIComponent(cookieItems.substring(target.length));
        }
        return null;
      } catch (err) { console.warn('[UTM Cookie] getItem failed:', name, err); return null; }
    },
    removeItem: function (name) {
      try {
        const past = 'Thu, 01 Jan 1970 00:00:00 GMT';
        const secure = (location.protocol === 'https:') ? ' Secure;' : '';
        const domain = COOKIE_DOMAIN ? (' domain=' + COOKIE_DOMAIN + ';') : '';
        document.cookie =
          encodeURIComponent(name) + '=; expires=' + past + '; path=' + COOKIE_PATH + ';' + domain + ' SameSite=Lax;' + secure;
      } catch (err) { console.warn('[UTM Cookie] removeItem failed:', name, err); }
    }
  };

  // URL helpers
  function hasUtmsInURL() {
    const qs = new URLSearchParams(window.location.search);
    return UTM_KEYS.some(utmKey => qs.has(utmKey));
  }
  function getUtmsFromURL() {
    const qs = new URLSearchParams(window.location.search);
    const out = {};
    UTM_KEYS.forEach(utmKey => {
      const val = qs.get(utmKey);
      if (val) out[utmKey] = val.trim();
    });
    return out;
  }


  // cookie helpers
  // 'k' means 'key', 'v', means 'value'
  function saveUtms(utms) {
    try {
      Object.entries(utms).forEach(([k, v]) => {
        cookieStorage.setItem(COOKIE_NAME_MAP[k] || k, v, COOKIE_HOURS);
      });
    } catch (err) { console.warn('[UTM Cookie] Failed to save UTMs:', err); }
  }
  function loadUtms() {
    const out = {};
    UTM_KEYS.forEach(k => {
      const v = cookieStorage.getItem(COOKIE_NAME_MAP[k] || k);
      if (v) out[k] = v; // keep keys plain: utm_source, etc.
    });
    return out;
  }

  // Marketo fallback (cookies -> hidden fields) should only run when URL has NO UTMs
  function applyCookieUtmsToForm(form) {
    if (hasUtmsInURL()) return;// if URL has UTMs, let marketo handle it - core functionality of marketo
    try {
      const stored = loadUtms();
      if (!Object.keys(stored).length) return;

      const formElem = form.getFormElem()[0];
      const currentVals = form.getValues();
      const updates = {};

      UTM_KEYS.forEach(utmKey => {
        const candidates = FIELD_NAMES[utmKey] || [utmKey];
        for (const fieldName of candidates) {
          if (fieldName in currentVals) {
            const input = formElem.elements[fieldName];
            const existing = (currentVals[fieldName] || (input && input.value) || '').trim();
            const fallback = (stored[utmKey] || '').trim();
            if (!existing && fallback) {
              updates[fieldName] = fallback;// fill only the empty fields
            }
            break;
          }
        }
      });

      if (Object.keys(updates).length) form.setValues(updates);
    } catch (err) { console.warn('[UTM Cookie] Failed to apply UTM data to form:', err); }
  }

  // \wait for Marketo, then apply cookie fallback if needed. should run AFTER marketo has loaded
  (function waitForMkto(maxMs = 10000, step = 200) {
    const ready = !!(window.MktoForms2 && typeof MktoForms2.whenReady === 'function');
    if (ready) {
      MktoForms2.whenReady(function (form) {
        // Optional: debug what fields Marketo exposes
        // try { console.log('[Mkto] keys:', Object.keys(form.getValues())); } catch (e) {}
        applyCookieUtmsToForm(form);
      });
      return;
    }
    if (maxMs <= 0) return;
    setTimeout(() => waitForMkto(maxMs - step, step), step);
  })();

  // Init: on any page WITH UTMs, store them for 48h
  (function init() {
    const urlUtms = getUtmsFromURL();
    if (Object.keys(urlUtms).length) {
      saveUtms(urlUtms);// write/refresh cookies; Marketo will use URL on this page
    }
  })();

  // helper for testing
  window.__resetUTMCookies = function () {
    UTM_KEYS.forEach(k => cookieStorage.removeItem(COOKIE_NAME_MAP[k] || k));
    console.log('[UTM Cookie] Cleared all iiq_utm cookies.');
  };
})();
</script>
